<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时监控 - 隧道废水处理智能平台</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/modules.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-water"></i>
                <span class="logo-text">废水处理平台</span>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-label">综合看板</div>
                    <div class="menu-item">
                        <a href="dashboard-company.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="menu-text">公司级看板</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="dashboard-project.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="menu-text">项目级看板</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">设备管理</div>
                    <div class="menu-item">
                        <a href="device-list.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-list"></i></span>
                            <span class="menu-text">设备档案</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">在线监控</div>
                    <div class="menu-item has-submenu">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-desktop"></i></span>
                            <span class="menu-text">实时监控</span>
                            <span class="menu-arrow expanded"><i class="fas fa-chevron-down"></i></span>
                        </a>
                        <div class="submenu open">
                            <div class="menu-item">
                                <a href="monitor-realtime.html" class="menu-link active">
                                    <span class="menu-text">实时数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-history.html" class="menu-link">
                                    <span class="menu-text">历史数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-alarm.html" class="menu-link">
                                    <span class="menu-text">报警管理</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-video.html" class="menu-link">
                                    <span class="menu-text">视频监控</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-digitaltwin.html" class="menu-link">
                                    <span class="menu-text">数字孪生</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">统计分析</div>
                    <div class="menu-item">
                        <a href="report-list.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="menu-text">数据报表</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="report-energy.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-bolt"></i></span>
                            <span class="menu-text">能耗统计</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">系统管理</div>
                    <div class="menu-item">
                        <a href="user-manage.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-users"></i></span>
                            <span class="menu-text">人员管理</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-cog"></i></span>
                            <span class="menu-text">系统设置</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="sidebar-overlay"></div>

        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav class="breadcrumb">
                        <span class="breadcrumb-item">
                            <a href="../index.html">首页</a>
                        </span>
                        <span class="breadcrumb-item">在线监控</span>
                        <span class="breadcrumb-item">实时数据</span>
                    </nav>
                </div>
                <div class="header-right">
                    <button class="header-action notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="badge-count">3</span>
                    </button>
                    <button class="header-action fullscreen-btn">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <div class="user-details">
                            <div class="user-name">管理员</div>
                            <div class="user-role">系统管理员</div>
                        </div>
                    </div>
                    <a href="../index.html" class="header-action logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="content-container">
                    <div class="page-header">
                        <h1 class="page-title">实时监控</h1>
                        <p class="page-description">查看设备实时运行数据和状态</p>
                    </div>

                    <div class="monitor-panel">
                        <!-- 设备列表 -->
                        <div class="device-list">
                            <div class="device-list-header">
                                <i class="fas fa-server"></i> 设备列表
                            </div>
                            <div class="device-list-body" id="deviceList">
                                <!-- 设备列表将通过JS动态生成 -->
                            </div>
                        </div>

                        <!-- 监控内容 -->
                        <div class="monitor-content">
                            <!-- 设备信息 -->
                            <div class="monitor-info">
                                <h3 style="margin-bottom: 16px;" id="currentDeviceName">请选择设备</h3>
                                <div class="monitor-info-grid" id="monitorInfoGrid">
                                    <!-- 设备参数将通过JS动态生成 -->
                                </div>
                            </div>

                            <!-- 实时曲线 -->
                            <div class="monitor-chart">
                                <h4 style="margin-bottom: 12px;">
                                    <i class="fas fa-chart-line text-primary"></i> 实时曲线（最近1小时）
                                </h4>
                                <div id="realtimeChart" style="height: 280px;"></div>
                            </div>

                            <!-- 控制面板 -->
                            <div class="monitor-controls">
                                <h4 style="margin-bottom: 16px;">
                                    <i class="fas fa-sliders-h text-primary"></i> 设备控制
                                </h4>
                                <div class="control-panel" id="controlPanel">
                                    <!-- 控制按钮将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/data.js"></script>
    <script>
        let currentDeviceId = null;
        let realtimeChart = null;
        let refreshTimer = null;

        document.addEventListener('DOMContentLoaded', function() {
            initDeviceList();
            initChart();

            // 获取URL参数中的设备ID
            const deviceId = app.getUrlParam('deviceId');
            if (deviceId) {
                selectDevice(deviceId);
            } else {
                // 默认选择第一个在线设备
                const firstDevice = mockData.devices.find(d => d.status === 'running');
                if (firstDevice) {
                    selectDevice(firstDevice.id);
                }
            }
        });

        function initDeviceList() {
            const container = document.getElementById('deviceList');

            container.innerHTML = mockData.devices.map(device => `
                <div class="device-list-item" data-device-id="${device.id}" onclick="selectDevice('${device.id}')">
                    <span class="device-list-item-name">${device.name}</span>
                    <span class="device-list-item-status ${device.status === 'running' ? '' : device.status}"></span>
                </div>
            `).join('');
        }

        function selectDevice(deviceId) {
            currentDeviceId = deviceId;
            const device = mockData.devices.find(d => d.id === deviceId);
            if (!device) return;

            // 更新设备列表高亮
            document.querySelectorAll('.device-list-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.deviceId === deviceId) {
                    item.classList.add('active');
                }
            });

            // 更新设备信息
            document.getElementById('currentDeviceName').textContent = device.name;
            loadMonitorInfo(deviceId);
            loadControlPanel(deviceId);
            updateChart(deviceId);

            // 开始定时刷新
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                loadMonitorInfo(deviceId);
                updateChart(deviceId);
            }, 3000);
        }

        function loadMonitorInfo(deviceId) {
            const container = document.getElementById('monitorInfoGrid');
            const device = mockData.devices.find(d => d.id === deviceId);
            const realtimeData = mockData.deviceRealtimeData[deviceId] || {};

            const params = [
                { label: 'PH值', value: realtimeData.ph || '-', unit: '' },
                { label: '液位', value: realtimeData.liquidLevel || '-', unit: '%' },
                { label: '流量', value: realtimeData.flow || '-', unit: 'm³/h' },
                { label: '温度', value: realtimeData.temperature || '-', unit: '°C' },
                { label: '功率', value: realtimeData.power || '-', unit: 'kW' },
                { label: '状态', value: device.status === 'running' ? '运行中' : device.status === 'warning' ? '警告' : device.status === 'error' ? '故障' : '已停止', unit: '' }
            ];

            container.innerHTML = params.map(param => `
                <div class="device-param">
                    <div class="device-param-label">${param.label}</div>
                    <div class="device-param-value">${param.value}<span class="device-param-unit">${param.unit}</span></div>
                </div>
            `).join('');
        }

        function loadControlPanel(deviceId) {
            const container = document.getElementById('controlPanel');
            const device = mockData.devices.find(d => d.id === deviceId);
            const realtimeData = mockData.deviceRealtimeData[deviceId] || {};

            const controls = [
                { name: '主泵', id: 'pump', checked: realtimeData.power > 0 },
                { name: '加药泵', id: 'dosing', checked: true },
                { name: '搅拌机', id: 'mixer', checked: true },
                { name: '风机', id: 'blower', checked: true }
            ];

            container.innerHTML = controls.map(control => `
                <div class="control-item">
                    <span class="control-item-label">${control.name}</span>
                    <label class="control-switch">
                        <input type="checkbox" ${control.checked ? 'checked' : ''} onchange="toggleControl('${control.id}', this.checked)">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            `).join('');
        }

        function toggleControl(controlId, checked) {
            const action = checked ? '启动' : '停止';
            app.showToast(`${action} ${controlId}`, checked ? 'success' : 'warning');
        }

        function initChart() {
            realtimeChart = echarts.init(document.getElementById('realtimeChart'));

            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['PH值', '液位', '流量']
                },
                xAxis: {
                    type: 'category',
                    data: generateTimeLabels(),
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'PH值',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '液位(%) / 流量(m³/h)',
                        position: 'right'
                    }
                ],
                series: []
            };

            realtimeChart.setOption(option);

            window.addEventListener('resize', () => realtimeChart.resize());
        }

        function updateChart(deviceId) {
            if (!realtimeChart || !deviceId) return;

            const phData = generateRandomData(7.0, 7.5);
            const liquidLevelData = generateRandomData(60, 80);
            const flowData = generateRandomData(10, 20);

            realtimeChart.setOption({
                series: [
                    {
                        name: 'PH值',
                        type: 'line',
                        data: phData,
                        smooth: true,
                        itemStyle: { color: '#1890ff' }
                    },
                    {
                        name: '液位',
                        type: 'line',
                        yAxisIndex: 1,
                        data: liquidLevelData,
                        smooth: true,
                        itemStyle: { color: '#52c41a' }
                    },
                    {
                        name: '流量',
                        type: 'line',
                        yAxisIndex: 1,
                        data: flowData,
                        smooth: true,
                        itemStyle: { color: '#faad14' }
                    }
                ]
            });
        }

        function generateTimeLabels() {
            const labels = [];
            const now = new Date();
            for (let i = 12; i >= 0; i--) {
                const time = new Date(now - i * 5 * 60 * 1000);
                labels.push(time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0'));
            }
            return labels;
        }

        function generateRandomData(min, max) {
            const data = [];
            for (let i = 0; i < 13; i++) {
                data.push((Math.random() * (max - min) + min).toFixed(1));
            }
            return data;
        }
    </script>
</body>
</html>
