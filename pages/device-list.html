<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备档案 - 隧道废水处理智能平台</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/modules.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-water"></i>
                <span class="logo-text">废水处理平台</span>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-label">综合看板</div>
                    <div class="menu-item">
                        <a href="dashboard-company.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="menu-text">公司级看板</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="dashboard-project.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="menu-text">项目级看板</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">设备管理</div>
                    <div class="menu-item">
                        <a href="device-list.html" class="menu-link active">
                            <span class="menu-icon"><i class="fas fa-list"></i></span>
                            <span class="menu-text">设备档案</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">在线监控</div>
                    <div class="menu-item has-submenu">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-desktop"></i></span>
                            <span class="menu-text">实时监控</span>
                            <span class="menu-arrow"><i class="fas fa-chevron-down"></i></span>
                        </a>
                        <div class="submenu">
                            <div class="menu-item">
                                <a href="monitor-realtime.html" class="menu-link">
                                    <span class="menu-text">实时数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-history.html" class="menu-link">
                                    <span class="menu-text">历史数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-alarm.html" class="menu-link">
                                    <span class="menu-text">报警管理</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-video.html" class="menu-link">
                                    <span class="menu-text">视频监控</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-digitaltwin.html" class="menu-link">
                                    <span class="menu-text">数字孪生</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">统计分析</div>
                    <div class="menu-item">
                        <a href="report-list.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="menu-text">数据报表</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="report-energy.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-bolt"></i></span>
                            <span class="menu-text">能耗统计</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">系统管理</div>
                    <div class="menu-item">
                        <a href="user-manage.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-users"></i></span>
                            <span class="menu-text">人员管理</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-cog"></i></span>
                            <span class="menu-text">系统设置</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="sidebar-overlay"></div>

        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav class="breadcrumb">
                        <span class="breadcrumb-item">
                            <a href="../index.html">首页</a>
                        </span>
                        <span class="breadcrumb-item">设备管理</span>
                        <span class="breadcrumb-item">设备档案</span>
                    </nav>
                </div>
                <div class="header-right">
                    <button class="header-action notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="badge-count">3</span>
                    </button>
                    <button class="header-action fullscreen-btn">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <div class="user-details">
                            <div class="user-name">管理员</div>
                            <div class="user-role">系统管理员</div>
                        </div>
                    </div>
                    <a href="../index.html" class="header-action logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="content-container">
                    <div class="page-header">
                        <h1 class="page-title">设备档案</h1>
                        <p class="page-description">管理所有设备信息和档案</p>
                    </div>

                    <!-- 操作栏 -->
                    <div class="action-bar">
                        <div class="action-bar-left">
                            <div class="search-box">
                                <input type="text" class="search-input" placeholder="搜索设备名称、编号..." id="searchInput">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <select class="form-select filter-select" id="projectFilter">
                                <option value="">所有项目</option>
                            </select>
                            <select class="form-select filter-select" id="typeFilter">
                                <option value="">所有类型</option>
                            </select>
                            <select class="form-select filter-select" id="statusFilter">
                                <option value="">所有状态</option>
                                <option value="running">运行中</option>
                                <option value="stopped">已停止</option>
                                <option value="warning">警告</option>
                                <option value="error">故障</option>
                            </select>
                        </div>
                        <div class="action-bar-right">
                            <button class="btn btn-default" onclick="exportData()">
                                <i class="fas fa-download"></i> 导出
                            </button>
                            <button class="btn btn-primary" onclick="showAddDeviceModal()">
                                <i class="fas fa-plus"></i> 添加设备
                            </button>
                        </div>
                    </div>

                    <!-- 设备列表 -->
                    <div class="card">
                        <div class="card-body" style="padding: 0;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll">
                                        </th>
                                        <th>设备编号</th>
                                        <th>设备名称</th>
                                        <th>设备类型</th>
                                        <th>所属项目</th>
                                        <th>型号</th>
                                        <th>状态</th>
                                        <th>安装日期</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceTableBody">
                                    <!-- 设备数据将通过JS动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 分页 -->
                    <div class="card">
                        <div class="card-body" style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: var(--text-secondary);">
                                共 <span id="totalCount">0</span> 条记录
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-default" onclick="changePage('prev')" id="prevBtn">
                                    <i class="fas fa-chevron-left"></i> 上一页
                                </button>
                                <span style="padding: 8px 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px;">
                                    第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页
                                </span>
                                <button class="btn btn-sm btn-default" onclick="changePage('next')" id="nextBtn">
                                    下一页 <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 设备详情模态框 -->
    <div id="deviceDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">设备详情</h3>
                <button class="modal-close" onclick="app.hideModal('deviceDetailModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="deviceDetailContent">
                <!-- 设备详情内容将通过JS动态生成 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="app.hideModal('deviceDetailModal')">关闭</button>
                <button class="btn btn-primary" onclick="editDevice()">编辑</button>
            </div>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script src="../js/data.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let filteredDevices = [...mockData.devices];

        document.addEventListener('DOMContentLoaded', function() {
            initFilters();
            loadDeviceList();

            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', debounce(function() {
                filterDevices();
            }, 300));

            // 筛选功能
            document.getElementById('projectFilter').addEventListener('change', filterDevices);
            document.getElementById('typeFilter').addEventListener('change', filterDevices);
            document.getElementById('statusFilter').addEventListener('change', filterDevices);
        });

        function initFilters() {
            // 项目筛选
            const projectFilter = document.getElementById('projectFilter');
            mockData.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectFilter.appendChild(option);
            });

            // 类型筛选
            const typeFilter = document.getElementById('typeFilter');
            const types = [...new Set(mockData.devices.map(d => d.type))];
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }

        function filterDevices() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const projectValue = document.getElementById('projectFilter').value;
            const typeValue = document.getElementById('typeFilter').value;
            const statusValue = document.getElementById('statusFilter').value;

            filteredDevices = mockData.devices.filter(device => {
                const matchSearch = !searchValue ||
                    device.name.toLowerCase().includes(searchValue) ||
                    device.id.toLowerCase().includes(searchValue);

                const matchProject = !projectValue || device.projectId == projectValue;
                const matchType = !typeValue || device.type === typeValue;
                const matchStatus = !statusValue || device.status === statusValue;

                return matchSearch && matchProject && matchType && matchStatus;
            });

            currentPage = 1;
            loadDeviceList();
        }

        function loadDeviceList() {
            const tbody = document.getElementById('deviceTableBody');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageDevices = filteredDevices.slice(start, end);

            const statusText = {
                'running': '运行中',
                'stopped': '已停止',
                'warning': '警告',
                'error': '故障'
            };

            const statusTag = {
                'running': 'tag-success',
                'stopped': 'tag-info',
                'warning': 'tag-warning',
                'error': 'tag-danger'
            };

            tbody.innerHTML = pageDevices.map(device => `
                <tr>
                    <td><input type="checkbox" class="device-checkbox" value="${device.id}"></td>
                    <td>${device.id}</td>
                    <td>${device.name}</td>
                    <td>${device.type}</td>
                    <td>${device.projectName}</td>
                    <td>${device.model}</td>
                    <td><span class="tag ${statusTag[device.status]}">${statusText[device.status]}</span></td>
                    <td>${device.installDate}</td>
                    <td>
                        <button class="btn btn-sm btn-default" onclick="viewDeviceDetail('${device.id}')">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="monitorDevice('${device.id}')">
                            <i class="fas fa-desktop"></i> 监控
                        </button>
                    </td>
                </tr>
            `).join('');

            // 更新分页信息
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            document.getElementById('totalCount').textContent = filteredDevices.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);

            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }

            loadDeviceList();
        }

        function viewDeviceDetail(deviceId) {
            const device = mockData.devices.find(d => d.id === deviceId);
            if (!device) return;

            const content = document.getElementById('deviceDetailContent');
            const realtimeData = mockData.deviceRealtimeData[deviceId] || {};

            const statusText = {
                'running': '运行中',
                'stopped': '已停止',
                'warning': '警告',
                'error': '故障'
            };

            content.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <h4 style="margin-bottom: 16px;">基本信息</h4>
                        <table class="table" style="margin-bottom: 24px;">
                            <tr>
                                <td style="width: 120px; font-weight: bold;">设备编号</td>
                                <td>${device.id}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">设备名称</td>
                                <td>${device.name}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">设备类型</td>
                                <td>${device.type}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">型号</td>
                                <td>${device.model}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">制造商</td>
                                <td>${device.manufacturer}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">出厂日期</td>
                                <td>${device.productionDate}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">安装日期</td>
                                <td>${device.installDate}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">所属项目</td>
                                <td>${device.projectName}</td>
                            </tr>
                            <tr>
                                <td style="font-weight: bold;">状态</td>
                                <td><span class="tag ${device.status === 'running' ? 'tag-success' : device.status === 'warning' ? 'tag-warning' : 'tag-danger'}">${statusText[device.status]}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-6">
                        <h4 style="margin-bottom: 16px;">实时数据</h4>
                        <div class="row">
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">PH值</div>
                                    <div class="device-param-value">${realtimeData.ph || '-'}</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">液位</div>
                                    <div class="device-param-value">${realtimeData.liquidLevel || '-'} <span class="device-param-unit">%</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">流量</div>
                                    <div class="device-param-value">${realtimeData.flow || '-'} <span class="device-param-unit">m³/h</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">温度</div>
                                    <div class="device-param-value">${realtimeData.temperature || '-'} <span class="device-param-unit">°C</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">功率</div>
                                    <div class="device-param-value">${realtimeData.power || '-'} <span class="device-param-unit">kW</span></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="device-param">
                                    <div class="device-param-label">二维码</div>
                                    <div class="device-param-value" style="font-size: 12px;">${device.qrCode}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 style="margin: 24px 0 16px;">技术规格</h4>
                <table class="table">
                    <tr>
                        <td style="width: 120px; font-weight: bold;">处理能力</td>
                        <td>${device.specifications.capacity}</td>
                        <td style="width: 120px; font-weight: bold;">功率</td>
                        <td>${device.specifications.power}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">外形尺寸</td>
                        <td>${device.specifications.dimension}</td>
                        <td style="font-weight: bold;">重量</td>
                        <td>${device.specifications.weight}</td>
                    </tr>
                </table>

                <h4 style="margin: 24px 0 16px;">资产信息</h4>
                <table class="table">
                    <tr>
                        <td style="width: 120px; font-weight: bold;">原值</td>
                        <td>¥${device.originalValue.toLocaleString()}</td>
                        <td style="width: 120px; font-weight: bold;">折旧率</td>
                        <td>${(device.depreciationRate * 100).toFixed(0)}%</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">当前净值</td>
                        <td>¥${device.currentValue.toLocaleString()}</td>
                        <td style="font-weight: bold;">保修到期</td>
                        <td>${device.warrantyDate}</td>
                    </tr>
                </table>
            `;

            app.showModal('deviceDetailModal');
        }

        function monitorDevice(deviceId) {
            window.location.href = `monitor-realtime.html?deviceId=${deviceId}`;
        }

        function editDevice() {
            app.showToast('编辑设备功能开发中', 'info');
        }

        function showAddDeviceModal() {
            app.showToast('添加设备功能开发中', 'info');
        }

        function exportData() {
            const exportData = filteredDevices.map(device => ({
                '设备编号': device.id,
                '设备名称': device.name,
                '设备类型': device.type,
                '所属项目': device.projectName,
                '型号': device.model,
                '制造商': device.manufacturer,
                '状态': device.status,
                '安装日期': device.installDate
            }));

            app.exportToCsv(exportData, '设备列表.csv');
        }
    </script>
</body>
</html>
