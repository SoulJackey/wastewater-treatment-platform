<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司级BI看板 - 隧道废水处理智能平台</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/modules.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="page-wrapper">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-water"></i>
                <span class="logo-text">废水处理平台</span>
            </div>

            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-label">综合看板</div>
                    <div class="menu-item">
                        <a href="dashboard-company.html" class="menu-link active">
                            <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
                            <span class="menu-text">公司级看板</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="dashboard-project.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-chart-bar"></i></span>
                            <span class="menu-text">项目级看板</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">设备管理</div>
                    <div class="menu-item">
                        <a href="device-list.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-list"></i></span>
                            <span class="menu-text">设备档案</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">在线监控</div>
                    <div class="menu-item has-submenu">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-desktop"></i></span>
                            <span class="menu-text">实时监控</span>
                            <span class="menu-arrow"><i class="fas fa-chevron-down"></i></span>
                        </a>
                        <div class="submenu">
                            <div class="menu-item">
                                <a href="monitor-realtime.html" class="menu-link">
                                    <span class="menu-text">实时数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-history.html" class="menu-link">
                                    <span class="menu-text">历史数据</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-alarm.html" class="menu-link">
                                    <span class="menu-text">报警管理</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-video.html" class="menu-link">
                                    <span class="menu-text">视频监控</span>
                                </a>
                            </div>
                            <div class="menu-item">
                                <a href="monitor-digitaltwin.html" class="menu-link">
                                    <span class="menu-text">数字孪生</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">统计分析</div>
                    <div class="menu-item">
                        <a href="report-list.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="menu-text">数据报表</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="report-energy.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-bolt"></i></span>
                            <span class="menu-text">能耗统计</span>
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-label">系统管理</div>
                    <div class="menu-item">
                        <a href="user-manage.html" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-users"></i></span>
                            <span class="menu-text">人员管理</span>
                        </a>
                    </div>
                    <div class="menu-item">
                        <a href="javascript:void(0)" class="menu-link">
                            <span class="menu-icon"><i class="fas fa-cog"></i></span>
                            <span class="menu-text">系统设置</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="sidebar-overlay"></div>

        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav class="breadcrumb">
                        <span class="breadcrumb-item">
                            <a href="../index.html">首页</a>
                        </span>
                        <span class="breadcrumb-item">
                            <a href="dashboard-company.html">综合看板</a>
                        </span>
                        <span class="breadcrumb-item">公司级看板</span>
                    </nav>
                </div>
                <div class="header-right">
                    <button class="header-action notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="badge-count">3</span>
                    </button>
                    <button class="header-action fullscreen-btn">
                        <i class="fas fa-expand"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-avatar">A</div>
                        <div class="user-details">
                            <div class="user-name">管理员</div>
                            <div class="user-role">系统管理员</div>
                        </div>
                    </div>
                    <a href="../index.html" class="header-action logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="content-container">
                    <div class="page-header">
                        <h1 class="page-title">公司级BI看板</h1>
                        <p class="page-description">查看所有项目的整体运行情况和关键指标</p>
                    </div>

                    <!-- 关键指标卡片 -->
                    <div class="dashboard-stats" id="statsContainer">
                        <div class="stat-card">
                            <div class="stat-card-title">
                                <i class="fas fa-project-diagram"></i> 项目总数
                            </div>
                            <div class="stat-card-value" id="totalProjects">0</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-arrow-up trend-up"></i>
                                <span>较上月 +2</span>
                            </div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-card-title">
                                <i class="fas fa-cogs"></i> 运行设备
                            </div>
                            <div class="stat-card-value" id="runningDevices">0</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-check-circle"></i>
                                <span>正常运行中</span>
                            </div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-card-title">
                                <i class="fas fa-exclamation-triangle"></i> 今日报警
                            </div>
                            <div class="stat-card-value" id="todayAlarms">0</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-arrow-down trend-down"></i>
                                <span>较昨日 -3</span>
                            </div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-card-title">
                                <i class="fas fa-bolt"></i> 本月能耗
                            </div>
                            <div class="stat-card-value" id="monthEnergy">0</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-arrow-up trend-up"></i>
                                <span>kWh</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- GIS地图 -->
                        <div class="col-8">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">项目地理分布</span>
                                    <span class="card-extra">
                                        <i class="fas fa-map-marker-alt text-primary"></i>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div id="map"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 设备类型统计 -->
                        <div class="col-4">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">设备类型分布</span>
                                </div>
                                <div class="card-body">
                                    <div id="deviceTypeChart" style="height: 350px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- 项目列表 -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">项目列表</span>
                                    <div class="card-extra">
                                        <button class="btn btn-sm btn-default" onclick="refreshData()">
                                            <i class="fas fa-sync-alt"></i> 刷新
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="projectList" style="margin: 0;">
                                        <!-- 项目卡片将通过JS动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- 报警统计 -->
                        <div class="col-6">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">报警统计</span>
                                </div>
                                <div class="card-body">
                                    <div id="alarmChart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 能耗趋势 -->
                        <div class="col-6">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">近7天能耗趋势</span>
                                </div>
                                <div class="card-body">
                                    <div id="energyTrendChart" style="height: 300px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 实时报警列表 -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">实时报警列表</span>
                            <a href="monitor-alarm.html" class="btn btn-sm btn-default">
                                查看全部 <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>级别</th>
                                        <th>设备</th>
                                        <th>项目</th>
                                        <th>报警信息</th>
                                        <th>时间</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="alarmList">
                                    <!-- 报警数据将通过JS动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
        });

        // 初始化仪表盘
        function initDashboard() {
            loadStatistics();
            initMap();
            initDeviceTypeChart();
            initAlarmChart();
            initEnergyTrendChart();
            loadProjectList();
            loadAlarmList();

            // 自动刷新数据
            setInterval(refreshData, 30000);
        }

        // 加载统计数据
        function loadStatistics() {
            const stats = mockData.statistics;
            document.getElementById('totalProjects').textContent = stats.totalProjects;
            document.getElementById('runningDevices').textContent = stats.runningDevices;
            document.getElementById('todayAlarms').textContent = stats.today;
            document.getElementById('monthEnergy').textContent = stats.monthEnergy.toLocaleString();
        }

        // 初始化地图
        let map;
        function initMap() {
            // 初始化地图，中心点设置在中国
            map = L.map('map').setView([35.0, 105.0], 4);

            // 添加OpenStreetMap图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 添加项目标记
            mockData.projects.forEach(project => {
                const markerColor = {
                    'normal': '#52c41a',
                    'warning': '#faad14',
                    'danger': '#f5222d'
                }[project.status] || '#1890ff';

                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${markerColor};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid #fff;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #fff;
                        font-weight: bold;
                        font-size: 12px;
                    ">${project.deviceCount}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([project.location.lat, project.location.lng], {
                    icon: customIcon
                }).addTo(map);

                // 添加弹出信息
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">${project.name}</h3>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-color);"></i>
                            ${project.address}
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <i class="fas fa-cogs" style="color: var(--success-color);"></i>
                            设备数量: ${project.deviceCount}台
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <i class="fas fa-play-circle" style="color: var(--success-color);"></i>
                            运行中: ${project.runningDevices}台
                        </p>
                        <p style="margin: 5px 0; font-size: 13px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                            报警: ${project.alarmCount}条
                        </p>
                        <button onclick="window.location.href='dashboard-project.html?id=${project.id}'"
                            style="margin-top: 10px; padding: 5px 15px; background: var(--primary-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                            查看详情
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);
            });
        }

        // 初始化设备类型图表
        function initDeviceTypeChart() {
            const chart = echarts.init(document.getElementById('deviceTypeChart'));
            const data = mockData.deviceTypeStats;

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}台 ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center'
                },
                series: [
                    {
                        name: '设备类型',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}\n{c}台'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        data: Object.entries(data).map(([name, value]) => ({ name, value }))
                    }
                ]
            };

            chart.setOption(option);

            // 响应式调整
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // 初始化报警统计图表
        let alarmChart = null;
        function initAlarmChart() {
            const chartDom = document.getElementById('alarmChart');
            if (!chartDom) return;

            alarmChart = echarts.init(chartDom);
            // 使用 statistics 中的报警级别数据
            const stats = mockData.statistics;

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}条'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center'
                },
                series: [
                    {
                        name: '报警级别',
                        type: 'pie',
                        radius: ['40%', '65%'],
                        center: ['40%', '50%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 5,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}\n{c}条'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        data: [
                            { value: stats.highAlarms, name: '高级报警', itemStyle: { color: '#f5222d' } },
                            { value: stats.mediumAlarms, name: '中级报警', itemStyle: { color: '#faad14' } },
                            { value: stats.lowAlarms, name: '低级报警', itemStyle: { color: '#52c41a' } }
                        ]
                    }
                ]
            };

            alarmChart.setOption(option);

            window.addEventListener('resize', function() {
                if (alarmChart) alarmChart.resize();
            });
        }

        // 初始化能耗趋势图表
        function initEnergyTrendChart() {
            const chart = echarts.init(document.getElementById('energyTrendChart'));
            const data = mockData.energyHistory.slice(-7); // 最近7天

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: '{b}<br/>能耗: {c} kWh'
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.date.slice(5)),
                    axisLine: {
                        lineStyle: { color: '#d9d9d9' }
                    },
                    axisLabel: {
                        color: '#8c8c8c'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: { color: '#d9d9d9' }
                    },
                    axisLabel: {
                        color: '#8c8c8c',
                        formatter: '{value}'
                    },
                    splitLine: {
                        lineStyle: { color: '#f0f0f0' }
                    }
                },
                series: [
                    {
                        name: '能耗',
                        type: 'line',
                        data: data.map(item => item.totalEnergy),
                        smooth: true,
                        itemStyle: {
                            color: '#1890ff'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(24, 144, 255, 0.3)' },
                                    { offset: 1, color: 'rgba(24, 144, 255, 0.05)' }
                                ]
                            }
                        },
                        lineStyle: {
                            width: 3
                        }
                    }
                ]
            };

            chart.setOption(option);

            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // 加载项目列表
        function loadProjectList() {
            const container = document.getElementById('projectList');
            const projects = mockData.projects;

            container.innerHTML = projects.map(project => `
                <div class="col-3" style="padding: 8px;">
                    <div class="project-card status-${project.status}" onclick="window.location.href='dashboard-project.html?id=${project.id}'">
                        <div class="project-card-title">${project.name}</div>
                        <div class="project-card-meta">
                            <div class="project-card-meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${project.address}</span>
                            </div>
                            <div class="project-card-meta-item">
                                <i class="fas fa-tag"></i>
                                <span>${project.type}</span>
                            </div>
                        </div>
                        <div class="project-card-stats">
                            <div class="project-card-stat">
                                <div class="project-card-stat-label">设备数</div>
                                <div class="project-card-stat-value">${project.deviceCount}</div>
                            </div>
                            <div class="project-card-stat">
                                <div class="project-card-stat-label">运行中</div>
                                <div class="project-card-stat-value" style="color: var(--success-color);">${project.runningDevices}</div>
                            </div>
                            <div class="project-card-stat">
                                <div class="project-card-stat-label">报警</div>
                                <div class="project-card-stat-value" style="color: ${project.alarmCount > 0 ? 'var(--danger-color)' : 'var(--text-primary)'};">${project.alarmCount}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 加载报警列表
        function loadAlarmList() {
            const container = document.getElementById('alarmList');
            const alarms = mockData.alarms.slice(0, 5); // 只显示前5条

            const levelText = {
                'high': '高',
                'medium': '中',
                'low': '低'
            };

            const statusText = {
                'pending': '未处理',
                'processing': '处理中',
                'processed': '已处理'
            };

            const statusTag = {
                'pending': 'tag-danger',
                'processing': 'tag-warning',
                'processed': 'tag-success'
            };

            container.innerHTML = alarms.map(alarm => `
                <tr>
                    <td>
                        <span class="tag ${alarm.level === 'high' ? 'tag-danger' : alarm.level === 'medium' ? 'tag-warning' : 'tag-info'}">
                            ${levelText[alarm.level]}
                        </span>
                    </td>
                    <td>${alarm.deviceName}</td>
                    <td>${alarm.projectName}</td>
                    <td>${alarm.message}</td>
                    <td>${alarm.createTime}</td>
                    <td><span class="tag ${statusTag[alarm.status]}">${statusText[alarm.status]}</span></td>
                    <td>
                        <button class="btn btn-sm btn-default" onclick="viewAlarmDetail('${alarm.id}')">
                            查看
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 查看报警详情
        function viewAlarmDetail(alarmId) {
            app.showToast('查看报警详情: ' + alarmId, 'info');
        }

        // 刷新数据
        function refreshData() {
            app.showToast('正在刷新数据...', 'info');

            // 模拟数据刷新
            setTimeout(() => {
                loadStatistics();
                loadAlarmList();
                app.showToast('数据刷新成功', 'success');
            }, 500);
        }
    </script>
</body>
</html>
